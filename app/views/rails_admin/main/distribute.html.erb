<div class="distribute-container">
  <div class="overlay"></div>
  <div class="not-distributed">
    <%= form_with model: @object, url: distribute_path(model_name: 'poll', id: @object.id), method: :put, class: 'students--container' do |form| %>
      <%= render @not_dist_students, form: form, course_id: nil %>
    <% end %>
    <div class="students--actions">
      <div class="students--count"><%= t('admin.actions.distribute.students_count', count: @not_dist_students.length) %></div>
      <%= form_with model: @object, url: distribute_path(model_name: 'poll', id: @object.id), method: :put do |form| %>
        <% @not_dist_students.each do |student| %>
          <%= form.fields_for("courses_students[]", student) do |sub_form| %>
            <%= sub_form.hidden_field :student_id, value: student.id %>
            <%= sub_form.hidden_field :course_id, value: student.selection_for(@object)&.top_course_id %>
          <% end %>
        <% end %>
        <%= button_tag t('admin.actions.distribute.distribute_all'), type: 'submit', disabled: @not_dist_students.empty?, id: 'distribute-all', class: 'students--distribute btn btn-primary' %>
      <% end %>
      <%= form_with model: @object, url: distribute_path(model_name: 'poll', id: @object.id), method: :put do |form| %>
        <% @courses.map(&:students).flatten.each do |student| %>
          <%= form.fields_for("courses_students[]", student) do |sub_form| %>
            <%= sub_form.hidden_field :student_id, value: student.id %>
            <%= sub_form.hidden_field :course_id, value: nil %>
          <% end %>
        <% end %>
        <%= button_tag t('admin.actions.distribute.reset_all'), type: 'sumbit', disabled: @courses.map(&:students).flatten.empty?, id: 'reset-all', class: 'students--reset btn btn-danger' %>
      <% end %>
    </div>
  </div>

  <div class="courses--container">
    <% @courses.each do |course| %>
      <%= content_tag :div, id: "course-container-#{course.id}", class: classes_for(course) do %>
        <%= form_with model: @object, url: distribute_path(model_name: 'poll', id: @object.id), method: :put, class: 'course-students', data: { course_id: course.id } do |form| %>
          <%= render course.students.sort_by { |s| [s.last_name, s.first_name] }, form: form, course_id: course.id %>
        <% end %>
        <div class="course-description">
          <div class="course-description--title"><%= '(G) ' if course.guaranteed? %><%= course.title %></div>
          <div class="course-description--teacher"><%= course.teacher_name %></div>
          <div class="course-description--min-to-max">
            <%= t('admin.actions.distribute.course.min_to_max', min: course.minimum, max: course.maximum) unless course.guaranteed? %>
          </div>
          <div class="course-description--count">
            <% if course.maximum %>
              <% if course.students.length >= course.maximum %>
                <i class="text-danger icon-warning-sign"></i>
                <%= '+' if (course.students.length - course.maximum).positive? %><%= course.students.length - course.maximum %>
              <% else %>
                <%= course.maximum - course.students.length%>
              <% end %>
              <div class="progress progress-flat">
                <%= content_tag :div, '', class: "progress-bar", role: "progressbar", style: "width: #{[100, (course.students.length.to_f / course.maximum.to_f) * 100].min}%" %>
              </div>
            <% else %>
              <%= course.students.length %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
